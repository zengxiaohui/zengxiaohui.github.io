define(function(require){function parsingLag(){uParse("body",{rootPath:"/static/component/base/ueditor/",chartContainerHeight:500})}function showPraiseUser(){$.ajax({url:"/article/getupvoteusers?id="+pageInfo.id,type:"get",dataType:"json",success:function(a){if(1===a.result){var c=a.data;if(0==c.length)$(".show-praise-wrap").css({opacity:"0",height:"0px","margin-bottom":"0px"});else for(var i=0;i<c.length;i++)$("#js-praise-show").append('<li class="l"><a target="_blank" href="/u/'+c[i].uid+'/articles">                                                <img src="'+c[i].img+'" title="'+c[i].nickname+'"/>                                                </a></li>')}},complete:function(){}})}function showAuthors(){$.ajax({url:"/article/getuser?uid="+authorUid.uid,type:"get",dataType:"json",success:function(a){0===a.result&&($(".article-num").find("span").text(a.data.article),$(".article-recom").find("span").text(a.data.support))},complete:function(){}})}function loadRelateRead(){$.ajax({url:"/article/getsimilar",type:"get",dataType:"json",data:{id:pageInfo.id},success:function(a){if(0===a.result){var c=a.data;if(0!=c.length){$(".react-article").find("ul").before("<h2>相关阅读</h2>");for(var i=0;i<c.length;i++){var g=$(".react-article").find("ul");g.append('<li><a href="/article/'+c[i].id+'" title="'+c[i].title+'"><h3>'+c[i].title+"</h3></a></li>")}}}}})}function loadFeedback(a){a=a||1,$.ajax({url:"/article/ajaxcomment",type:"post",dataType:"json",data:{page:a,article_id:pageInfo.id},success:function(c){var g,h=parseInt(c.data.num%20),v=parseInt(c.data.num/20);if(g=h>0?v+1:v,0===c.result)if(c=c.data,$(".df-title .comment-num i").html(c.num),0==c.num)$("#js-feedback-list-wrap").html('<p class="feedback-none">暂无评论</p>'),$("#js-feedback-hot-list-wrap").hide(),$(".hot-df-title").hide();else{if(curPage=parseInt(a),1==curPage&&(0==c.hotcomments.length?($("#js-feedback-hot-list-wrap").hide(),$(".hot-df-title").hide()):($(".hot-df-title").show(),$("#js-feedback-hot-list-wrap").show(),displayHotList(c.hotcomments),$("#js-feedback-hot-list-wrap .reply-btn").hide())),displayList(c.data),prePage=curPage-1,nextPage=curPage+1,0>=prePage&&(prePage=1),nextPage>g&&(nextPage=g),g>1){var y=$(".qa-comment-page");y.append('<a href="javascript:void(0)" class="first" data-page="1">首页</a>','<a href="javascript:void(0)" class="pre" data-page="'+prePage+'">上一页</a>');for(var i=1;g>=i;i++)y.append('<a href="javascript:void(0)"  id="page_num" data-page="'+i+'">'+i+"</a>");y.append('<a href="javascript:void(0)"  class="next" data-page="'+nextPage+'">下一页</a>                                <a href="javascript:void(0)"  class="last" data-page="'+g+'">尾页</a>')}else $(".qa-comment-page").hide();for(var b=$(".qa-comment-page #page_num"),j=0;j<b.length;j++)if($(b[j]).attr("data-page")==a)if($(b[j]).addClass("active"),0==j?$(".qa-comment-page .first,.qa-comment-page .pre").addClass("disabled_page"):j==parseInt(g-1)&&$(".qa-comment-page .last,.qa-comment-page .next").addClass("disabled_page"),j>3){for(var i=0;j+1>i;i++)j-3>i&&$(b[i]).hide();for(var s=j+4;s<b.length;s++)$(b[s]).hide()}else if(b.length>7)for(var m=7;m<b.length;m++)$(b[m]).hide()}},complete:function(){parsingLag(),initEvent(),""==$(".reply-box").html()&&$(this).css("padding-top","25px")}})}function displayList(a){for(var s="",i=0,c=a.length;c>i;i++)s+=getHTML(a[i]);display(s)}function displayHotList(a){for(var s="",i=0,c=a.length;c>i;i++)s+=getHTMLs(a[i]);displays(s)}function display(a,c){var g=$("#js-feedback-list");g.length||($("#js-feedback-list-wrap .feedback-loading,#js-feedback-list-wrap .feedback-none").remove(),g=$('<div id="js-feedback-list"></div>').appendTo($("#js-feedback-list-wrap"))),g[c?"prepend":"append"](a)}function displays(a,c){var g=$("#js-feedback-hot-list");g.length||($("#js-feedback-hot-list-wrap .feedback-loading,#js-feedback-hot-list-wrap .feedback-none").remove(),g=$('<div id="js-feedback-hot-list"></div>').appendTo($("#js-feedback-hot-list-wrap"))),g[c?"prepend":"append"](a)}function getComment(a){var c,g="",h="",v="";return c=a.upvoted&&1==a.upvoted?'<span class="agree-with active r" data-commentid='+a.id+" data-uid="+a.uid+" data-username="+a.nickname+"><b>已赞同</b><em>"+a.support_num+"</em></span>":'<span class="agree-with r" data-commentid='+a.id+" data-uid="+a.uid+" data-username="+a.nickname+"><b>赞同</b><em>"+a.support_num+"</em></span>",1==a.mustar_switch&&(g='<i class="user-icon ismooc" title="慕星人"></i>'),1==a.is_author&&(h='<i class="user-icon great" title="认证作者"></i>'),2==a.user_type&&(v='<i class="user-icon teacher" title="慕课网讲师"></i>'),['<div class="comment clearfix">','<div class="feed-author l">','<a href="/u/',a.uid,'/articles" >','<img src="',a.img,'" width="40" >',"</a>",'<a class="nick" href="/u/',a.uid,'/articles" target="_blank">',a.nickname,"</a>",v,h,g,'<span class="com-floor r">',a.floor_num,"F</span>","</div>",'<div class="feed-list-content">',"<p>",a.content,"</p>",'<div class="comment-footer">','<span class="feed-list-times"> ',a.create_time,"</span>",'<span class="reply-btn" data-commentid=',a.id," data-uid=",a.uid," data-username=",a.nickname,">回复","</span>",c,"</div>","</div>","</div>"].join("")}function getReply(a){function c(a,c,g,h){return 0==_replyFlag?['<a href="/u/',a,'/articles" class="from-user">',g,"</a>："].join(""):a==c?['<a href="/u/',a,'/articles" class="from-user">',g,"</a>："].join(""):['<a href="/u/',a,'/articles" class="from-user">',g,"</a> 回复 ",'<a href="/u/',c,'/articles" class="to-user">',h,"</a>："].join("")}return['<div class="comment clearfix">','<div class="feed-author l">','<a href="/u/',a.from_uid,'/articles" >','<img src="',a.img,'" width="40" >',"</a>","</div>",'<div class="feed-list-content">',c(a.from_uid,a.to_uid,a.from_username,a.to_username),'<span class="feed-list-time r"> ',a.create_time,"</span>","<p>",a.description,"</p>",'<div class="comment-footer clearfix">','<span class="reply-btn reply-btns"'," data-commentid=",a.reply_id," data-uid=",a.from_uid," data-username=",a.from_username,">回复","</span>","</div>","</div>","</div>"].join("")}function getAllReply(a){var c="";if(a&&a.length)for(var i=0;i<a.length;i++)c+=getReply(a[i]);return c}function renderReleaseReply(a,c){return['<div class="release-reply">','<a href="/u/',a.uid,'/articles" class="user-head">','<img src="',a.img,'" alt="',a.nickname,'"/>',"</a>",'<a href="/u/',a.uid,'/articles" class="nick">',a.nickname,"</a>",'<div class="replay-con">','<div class="textarea-wrap">','<textarea placeholder="写下你的回复..."></textarea>',"</div>",'<p class="errtip"></p>','<div class="reply-ctrl clearfix">','<div class="verify-code"></div>','<div class="btn-wrap">','<div class="cancel-btn">取消</div>','<div data-comment-uid="',c,'" class="release-reply-btn">提交</div>',"</div>","</div>","</div>","</div>"].join("")}function getMoreReply(a,c){return!a||1>a?"":['<div class="getMoreReply" data-replyid=',c,">点击展开后面","<span>",a,"</span>条回复","</div>"].join("")}function getReplyBox(a,c,g){var h=0;return c&&(h=parseInt(c)-3),c?$(".reply-box").hide():$(".reply-box").show(),['<div class="reply-box">',getAllReply(a),getMoreReply(h,g),"</div>"].join("")}function getHTML(o){return['<div class="comment-box">',getComment(o,!0),getReplyBox(o.replys,o.comment_num,o.id),renderReleaseReply(user,o.uid),"</div>"].join("")}function getHTMLs(o){return['<div class="comment-box">',getComment(o,!0),"</div>"].join("")}function initEvent(){function a(a,c){var g=$(window).height(),h=a.height(),v=a.offset().top,y=(g-h)/2;$("html,body").animate({scrollTop:v-y+"px"},c,"swing")}var c={};c.reply_id=null,c.from_uid=null,$(".replay-con textarea").on("succ",function(){$(this).parent().parent().find("p.errtip").text("")}).on("fail",function(e,a){$(this).parent().parent().find("p.errtip").text(a)}),$("#js-feedback-list-wrap").delegate(".reply-btn","click",function(){var g=$(this).parents(".comment-box"),h=$(this).attr("data-username");return isLogin?(g.find(".release-reply").fadeIn(),$(this).hasClass("reply-btns")?(_replyFlag=1,g.find("textarea").focus().val("回复 "+h+"：").attr("touser","回复 "+h+"：")):_replyFlag=0,c.reply_id=$(this).attr("data-commentid"),c.from_uid=$(this).attr("data-uid"),g.siblings(".comment-box").find(".cancel-btn").click(),void a(g.find(".release-reply"),300)):void $("#js-signin-btn").click()}),$("#js-feedback-list-wrap").delegate(".cancel-btn","click",function(){var a=$(this).parents(".release-reply");a.find("textarea").trigger("succ").val(""),a.find(".verify-code").trigger("succ").html(""),a.css("display","none")}),$("#js-feedback-list-wrap").delegate(".release-reply-btn","click",function(e){var a=$(e.target),g=$(this);if(a.hasClass("release-reply-btn")){var h=g.parents(".comment-box").find(".replay-con"),v=g.parents(".comment-box").find(".reply-box"),y=g.parents(".comment-box").find("textarea"),b=(v.find(".getMoreReply").length>0?!0:!1,y.val());b=$.trim(b);var j=/^回复\s*\S+：/;if(j.test(b)?b=b.replace(j,""):c.from_uid=$.trim(a.attr("data-comment-uid")),b.length<3)return void h.find("textarea").trigger("fail","回复内容不得少于3个字");if(b.length>300)return void h.find("textarea").trigger("fail","回复内容不得多于300");h.find("textarea").trigger("succ"),$(".errtip").html("");var k={};if(k.reply_id=c.reply_id,k.from_uid=c.from_uid,k.description=b,0!==h.find(".verify-code-ipt").length){var _=$.trim(verifyCode.getResult(h.find(".verify-code")));if(0==_.length)return void h.find(".verify-code").trigger("fail","请输入验证码");k.verify_code=_}a.addClass("disabled").html("提交..."),$.ajax({url:"/article/savereplycomment",data:k,type:"post",dataType:"json",success:function(a){if(0==a.result){var c=getReply(a.data),g=v.find(".comment").length;if(3>g)v.append(c);else{var y=v.find(".getMoreReply").length>0?!0:!1;y||v.append(c);var $=parseInt(v.find(".getMoreReply span").text());v.find(".getMoreReply span").text($+1)}h.find(".cancel-btn").click()}else{if(-1==a.result&&1==a.data)return void verifyCode.renderVerifyCodeBlock(h.find(".verify-code"),"/article/getverifycode");-103002==a.result?h.find(".verify-code").trigger("fail","验证码错误"):h.find(".verify-code").trigger("succ")}},complete:function(){a.removeClass("disabled").html("提交")}})}}),$(".comment-box").on("click",function(e){var a=$(e.target);if(a.hasClass("getMoreReply")&&!a.hasClass("disabled")){var c=$(this).find(".reply-box"),g=$(e.target).attr("data-replyid");a.addClass("disabled").html("请稍等...");var h={};h.reply_id=g,h.page=2,$.ajax({url:"/article/getcomment",data:h,type:"post",dataType:"json",success:function(g){if(0==g.result){for(var h=g.data,v="",i=0;i<h.length;i++)v+=getReply(h[i]);a.remove(),c.append(v)}else a.remove()},complete:function(){}})}})}require("lib/pretty/prettify.js"),require("lib/pretty/prettify.css"),require("/static/lib/ueditor/ueditor.parse.js"),require("/static/lib/layer/1.6.0/layer.min.js"),require("/static/lib/layer/1.6.0/skin/layer.css"),require("/static/lib/ueditor/themes/imooc/css/ueditor.css"),require("/static/page/article/addCopy.js"),require("/static/page/article/imgPreview.js");var verifyCode=(require("/static/page/article/praise.js"),require("../common/verify-code.js"));prettyPrint();var _replyFlag,_submiToffTop=$(".df-title").offset().top+$(".df-ipt-wrap").height(),util={msg:function(a,c){var g=$(this).closest(".js-msg-context"),m=a?"addClass":"removeClass",h=c?"qa-tips-ok":"qa-tips-error";g.find(".qa-tips").removeClass("qa-tips-ok qa-tips-error")[m](h).html(a||"")},error:function(a,c){arguments.length<2&&(c=a,a=$(this).next(".errortip")),c?$(a).html(c):$(a).empty()}};if(showPraiseUser(),showAuthors(),loadRelateRead(),1==isLogin){{var opts={initialFrameHeight:100,initialFrameWidth:766},cueditor=UE.getEditor("js-reply-editor-box",opts);$(".pop-tips-layer")}cueditor.addListener("focus",function(){util.msg.call($("#js-reply-editor-box"))})}$("#js-submit").click(function(e){e.preventDefault();var a,c,g=$(this);if(!g.hasClass("loading")){if(c=$.trim(UE.getEditor("js-reply-editor-box").getContent()),a=UE.getEditor("js-reply-editor-box").getContentLength(!0),10>a)return void $("#feed-error").text("评论字数不能少于10个字！");if(a>1e3)return void $("#feed-error").text("评论字数不能超过1000个字！");$("#feed-error").text("");var h={};if(h.article_id=pageInfo.id,h.content=c,0!==$(this).parent().find(".verify-code-ipt").length){var v=$.trim(verifyCode.getResult(".verify-code"));if(0==v.length)return void $(".verify-code").trigger("fail","请输入验证码");h.verify=v}g.addClass("loading").text("正在提交..."),$(".verify-code").trigger("succ","请输入验证码"),$.ajax({url:"/article/ajaxpostcomment",type:"post",dataType:"json",data:h,success:function(a){if(0===a.result){a.data.user={uid:OP_CONFIG.userInfo.uid,nickname:OP_CONFIG.userInfo.nickname,img:OP_CONFIG.userInfo.head},display(getHTML(a.data),1),$("#feedback-area").val(""),$("#feed-error").html('<span style="color:#090;">评论成功</span>'),$(".verify-code").html(""),UE.getEditor("js-reply-editor-box").setContent(" ");var c=parseInt($(".df-title .comment-num").find("i").text());return $(".df-title .comment-num").find("i").text(c+1),$("html body").animate({scrollTop:_submiToffTop},300),void setTimeout(function(){$("#feed-error").text("")},2e3)}1===a.data&&-1===a.result?verifyCode.renderVerifyCodeBlock(".df-bottom .verify-code","/article/getarticlecommentcode"):-103002==a.result?($(".verify-code").trigger("fail",a.msg),setTimeout(function(){verifyCode.renderVerifyCodeBlock(".df-bottom .verify-code","/article/getarticlecommentcode")},2e3)):$("#feed-error").html(a.msg)},complete:function(){g.removeClass("loading").text("评论（Ctrl+Enter）"),parsingLag()}})}}),1==isLogin&&(cueditor.addListener("keydown",function(a,c){13==c.keyCode&&c.ctrlKey&&$("#js-submit").trigger("click")}),$(".verify-code input").on("keydown",function(a){a.ctrlKey&&13==a.keyCode&&$("#js-submit").trigger("click")})),loadFeedback(),$(".qa-comment-page").on("click","a",function(){if($(this).hasClass("disabled_page"))return!1;$(".hot-df-title").hide(),$("#js-feedback-hot-list-wrap").html(""),$("#js-feedback-list").html(" "),$(".qa-comment-page").html(" ");var a=$(".df-title").offset().top;$("html body").animate({scrollTop:a},600),loadFeedback($(this).attr("data-page"))}),$(".praise-box").click(function(){if(!OP_CONFIG.userInfo)return void seajs.use("login_sns",function(a){a.init()});var a=$(this).find("span"),p=a.hasClass("praised");$("#js-praise").hasClass("loading")||($("#js-praise").addClass("loading"),$.ajax({url:"/article/ajaxupvote",type:"post",dataType:"json",data:{article_id:pageInfo.id},success:function(c){if(0===c.result&&!p){a.find("span").addClass("praised"),$(".show-praise-wrap").css({opacity:"1",height:"30px","margin-bottom":"30px"});var g=$(".show-praise-wrap .praise-num").find(".num"),h=parseInt(pageInfo.praiseNum);h+=1,g.html(h),console.log(h),$("#js-praise-show").prepend('<li class="l"><a target="_blank" href="/u/'+user.uid+'/articles">                                                <img src="'+user.img+'" title="'+user.nickname+'"/>                                                </a></li>')}},complete:function(){$("#js-praise").removeClass("loading")}}))}),$("#js-follow").click(function(){if(!OP_CONFIG.userInfo)return void seajs.use("login_sns",function(a){a.init()});var a=$(this),p=a.hasClass("dc-followed");a.hasClass("loading")||(a.addClass("loading"),$.ajax({url:p?"/article/ajaxdelcollect":"/article/ajaxcollect",type:"post",dataType:"json",data:{article_id:pageInfo.id},success:function(c){0===c.result&&(a[p?"removeClass":"addClass"]("dc-followed"),a.find("span").text(p?"收藏":"取消收藏"))},complete:function(){a.removeClass("loading")}}))}),$(".detail-feedback-wrap").delegate(".agree-with","click",function(){if(!isLogin)return void $("#js-signin-btn").click();var a=$(this).attr("data-commentid"),c=$(this),g=c.hasClass("active");c.hasClass("loading")||(c.addClass("loading"),$.ajax({url:"/article/ajaxupvotecomment",type:"post",dataType:"json",data:{comment_id:a},success:function(a){if(0==a.result&&!g){c.addClass("active");var h=c.find("em"),v=parseInt(h.text());v+=1,h.text(v),c.find("b").text(g?"赞同":"已赞同")}},complete:function(){}}))});var articlename=$.trim($(".detail-title").text()),imgPic=$("#js-share-img").attr("data-pic"),title="我刚刚在@慕课网 读了篇好手记："+articlename+"_慕课网_手记",link="http://www.mukewang.com"+window.location.pathname;with(imgPic?imgPic="http://img.mukewang.com/"+imgPic+".jpg":"",window._bd_share_config={common:{bdUrl:link,bdSnsKey:{tsina:"2788596354"},bdText:title,bdMini:"2",bdMiniList:!1,bdPic:imgPic,bdStyle:"0",bdSize:"16",searchPic:""},share:{}},document)0[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)];shareFrame=$(".js-share-statue"),setTimeout(function(){shareFrame.hide()},5e3);var timer,shareEles=$(".bdsharebuttonbox a"),sendId=pageInfo.id,ajaxing=0,interval=1;shareEles.on("click",function(e){ajaxing||(ajaxing=1,shareFrame.hide(),$.ajax({type:"post",url:"/course/courseshare",data:"id="+sendId+"&type=5",success:function(){ajaxing=0},error:function(){layer.msg("网络错误，请稍后再试",1,1)},complete:function(){isAjax=0}}),e.preventDefault())}).mouseenter(function(){shareFrame.show()}).mouseleave(function(){timer&&clearTimeout(timer),timer=setTimeout(function(){shareFrame.hide()},interval)});var directory={init:function(){this.event()},directory$:$(".directory"),top:$(".detail-right").offset().top+$(".detail-right").outerHeight(),bottom:$(".detail-content-wrap").offset().top+$(".detail-content-wrap").outerHeight(),anchor:$("#article_directory").find(".dire"),event:function(){var a=this;$(document).on("scroll",function(){var c=$(window).scrollTop();a.follow(c),a._scroll(c)})},follow:function(a){var c=$(".detail-left").offset().left,g=$(".detail-left").width(),h=c+g+80+"px";$("#article_directory").css(a>=this.top&&a<=this.bottom?{position:"fixed",top:"5px",left:h}:{position:"relative",top:"0px",left:"0px"})},_scroll:function(a){var c=this,g=(this.directory$.find(".title-link"),$(".anchor-list"));g.each(function(){var g=$(this).children("a"),h=g.attr("name");g.offset().top-20<=a&&c.anchor.each(function(){if($(this).find(".title-link").attr("href").substr(1)==h){{this.tagName}$(".dire-list li").removeClass("active"),$(this).addClass("active")}})})}};$("#article_directory")[0]&&(directory.init(),$(".dire-list").on("click","li",function(){$(this).addClass("active").siblings().removeClass("active")})),$(document).mouseup(function(e){var a=$("#bdshare_weixin_qrcode_dialog");a.is(e.target)||0!=a.has(e.target).length||(a.hide().remove(),$("#bdshare_weixin_qrcode_dialog_bg").attr("display","none").remove())}),$("#js-text-login").click(function(){return OP_CONFIG.userInfo?void 0:void seajs.use("login_sns",function(a){a.init()})})});